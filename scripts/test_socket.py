import time
import socket
import struct

import pandas as pd

from forza_telemetry import TelemetryParser

ip = "127.0.0.1" # "169.254.72.170"
port = 6669

sock = socket.socket(socket.AF_INET, # Internet
                     socket.SOCK_DGRAM) # UDP

#udp_data = b'\x01\x00\x00\x00oW\x12\x00\xf6\xff\xf9E\xf8\xffGD\xab\x00HD\xf1\xd7\xe38\xbd\x95\x03\xbb\xa0z\x898\xc6\x08\x7f6h\xad\x068\xcc\xc2f\xb6s\x0b\xd6\xb6\x93\xd7#6T\xba\x887\xf6`L?\xaa}\x05=\x91k]\xbdR\x17\xe4>,\x8e\xa0>\xd8)\x85>\xd3k\xdf>\xe8p\xc1\xbbq\xa38\xbc@\xd9[\xb9,\x90\x1e9\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x99\x99\x19?\x99\x99\x19?\x99\x99\x19?\x99\x99\x19?\xf9\xb7!\xbcq17\xbd\xa3Q\xc4\xbc9g\x009bo<<K\xeb<=\x8fS\xc4<\x93\x08L9\x00\x80\xe9;\xe0\x9d\xd9\xbb \xc2\x19\xbc\xe0\x99\x08<\x86\x08\x00\x00\x03\x00\x00\x00\xe4\x02\x00\x00\x02\x00\x00\x00\x04\x00\x00\x00\x12\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00l\xddeE^\x11\tC\x1c\xc2 E\xcfa\x088\xd1x\xc0\xbc*\t\x93\xb9\x0e4\xf2BDL\xf6B\x8e\xe6\xedB\x8e\xe6\xedBdf0\xc1\x00\x00\x80?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd1\xfcjD\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00'
telemetry_parser = TelemetryParser()

df = pd.read_csv("../data/telemetry_20200317074355.csv")
df = df[df["IsRaceOn"] == 1]

fps = 1

print("Sending data...")
for i in range(df.shape[0]):
    print(i)
    udp_data = struct.pack(telemetry_parser.struct_format, *[df[col].iloc[i] for col in df])
    sock.sendto(udp_data, (ip, port))
    time.sleep(1./fps)
print("Done.")
